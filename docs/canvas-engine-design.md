# Canvas Isolation Pattern 設計書

## 概要

UIフレームワーク（React、Vue等）に依存しない、疎結合なCanvas処理を実現するアーキテクチャパターン。

UI世界から完全に隔絶されたCanvas世界を構築し、単一方向のデータフローにより責任を明確に分離する。

---

## 目的

- UIフレームワークとCanvas世界の分離
- Canvas世界は純粋なTypeScriptで、フレームワーク依存なし
- フレームワーク移行時もCanvas世界はそのまま使える
- 高い合成可能性とメンテナンス性

---

## 設計原則

### Stateは唯一のデータソース

- SetterとRenderは互いを知らない
- SetterとRenderのどちらを呼ぶか、組み合わせるかは外部が決める
- Facadeは公開窓口であり、処理は持たない

### RenderからStateへの書き込み

- Renderは**直接State**を更新する（Setterを経由しない）
- 理由: Setterの責務は「外部からStateへの書き込み口」。RenderはCanvas世界内部なのでSetterを経由する必要がない

### 描画の流れ

- SetterはStateに事実を記録する
- Renderは振る舞いを判断する

---

## Canvas世界と外部の責任境界

### Canvas世界の責任

- 受け取った命令を忠実に実行
- 命令の妥当性検証は行わない

### 外部(UI世界)の責任

- 適切なタイミングでのSetter/Render呼び出し
- 不適切な操作(競合するアニメーション、無効なパラメータ等)の防止

### 情報の公開方針

- **原則**: 外部はCanvas世界の内部(State, Setter, Renderの実装等)を直接参照できない
- **例外**: 必要に応じて、Renderを通して特定のスコープ内で情報を公開できる
  - 例: Render関数にonUpdateコールバックを渡すことで、アニメーション進捗を受け取る
  - 公開される情報はRenderが制御する

Canvas世界は外部の都合を知らず、Facadeが唯一の接点。

---

## 用語

| 用語 | 意味 |
|------|------|
| Canvas世界 | Facade, Setter, Render, Stateで構成される隔絶された空間 |
| Facade | 外部への唯一の公開窓口。SetterとRenderをexportする（処理は持たない） |
| Setter | 外部からStateへの書き込み口（事実の記録） |
| Render | 描画、フレームループ管理、フレームごとのState更新（振る舞いの判断） |
| State | 状態の現在値を保持するデータ構造 |

---

## アーキテクチャ

```
┌─────────────────────────────────────────┐
│           外部（UIフレームワーク）        │
│   - Canvas世界を知らない                 │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────┐
│            Canvas世界                            │
│                                                  │
│  ┌───────────────────────────────────────┐      │
│  │  Facade（公開窓口）                   │      │
│  │  - 外部への唯一の接点                 │      │
│  │  - 処理は持たない                     │      │
│  └────────┬──────────────┬───────────────┘      │
│           │              │                       │
│           ▼              ▼                       │
│  ┌──────────────┐  ┌──────────────────────┐     │
│  │ Setter       │  │ Render               │     │
│  │              │  │ - 描画               │     │
│  │              │  │ - ループ管理         │     │
│  └──────┬───────┘  └──────┬───────────────┘     │
│         │                 │                      │
│         ▼                 ▼                      │
│  ┌────────────────────────────────────────┐     │
│  │  State（データ構造）                   │     │
│  │  - 状態の現在値を保持                  │     │
│  │  - 依存ゼロ                            │     │
│  └────────────────────────────────────────┘     │
│                                                  │
└──────────────────────────────────────────────────┘
```

### データフロー

```
外部 ──→ Facade ──→ Setter ──→ State ──→ Render
                                 ▲         │
                                 └─────────┘
```

---

## 参考資料

- [Game Programming Patterns - Game Loop](https://gameprogrammingpatterns.com/game-loop.html)
- [MDN - Anatomy of a video game](https://developer.mozilla.org/en-US/docs/Games/Anatomy)
- [Martin Fowler - GUI Architectures](https://martinfowler.com/eaaDev/uiArchs.html)
